(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.ObservableMembrane=b()})(this,function(){"use strict";function a(a){return a===void 0}function b(a){if(null==a)return!1;if(i(a))return!0;const b=j(a);return b===v||null===b||null===j(b)}function c(a){return"object"==typeof a}function d(a){return"value"in a&&(a.value=y(a.value)),a}function e(a,c){return"value"in c&&(c.value=b(c.value)?a.getProxy(c.value):c.value),c}function f(a,b,c){const d=t.call(p(c),q(c));d.forEach(d=>{let f=o(c,d);f.configurable||(f=e(a,f)),l(b,d,f)}),r(b)}function g(a,c){return"value"in c&&(c.value=b(c.value)?a.getReadOnlyProxy(c.value):c.value),c}function h(a){let b;return i(a)?b=[]:c(a)&&(b={}),b}const{isArray:i}=Array,{getPrototypeOf:j,create:k,defineProperty:l,defineProperties:m,isExtensible:n,getOwnPropertyDescriptor:o,getOwnPropertyNames:p,getOwnPropertySymbols:q,preventExtensions:r}=Object,{push:s,concat:t,map:u}=Array.prototype,v=Object.prototype,w=Symbol(),{getKey:x}=Proxy,y=x?a=>a&&x(a,w)||a:a=>a&&a[w]||a;class z{constructor(b,c,d){this.originalTarget=c,this.membrane=b,a(d)||(this.valueMutated=d.valueMutated,this.valueObserved=d.valueObserved)}get(b,c){const{originalTarget:d,membrane:e}=this;if(c===w)return d;const f=d[c],{valueObserved:g}=this;return a(g)||g(d,c),e.getProxy(f)}set(b,c,d){const{originalTarget:e,valueMutated:f}=this,g=e[c];return g===d?"length"===c&&i(e)&&!a(f)&&f(e,c):(e[c]=d,!a(f)&&f(e,c)),!0}deleteProperty(b,c){const{originalTarget:d,valueMutated:e}=this;return delete d[c],a(e)||e(d,c),!0}apply(){}construct(){}has(b,c){const{originalTarget:d,valueObserved:e}=this;return a(e)||e(d,c),c in d}ownKeys(){const{originalTarget:a}=this;return t.call(p(a),q(a))}isExtensible(a){const b=n(a);if(!b)return b;const{originalTarget:c,membrane:d}=this,e=n(c);return e||f(d,a,c),e}setPrototypeOf(){}getPrototypeOf(){const{originalTarget:a}=this;return j(a)}getOwnPropertyDescriptor(b,c){const{originalTarget:d,membrane:f,valueObserved:g}=this;a(g)||g(d,c);let h=o(d,c);if(a(h))return h;const i=o(b,c);return h.configurable||i||(h=e(f,h),l(b,c,h)),i||h}preventExtensions(a){const{originalTarget:b,membrane:c}=this;return f(c,a,b),r(b),!0}defineProperty(b,c,f){const{originalTarget:g,membrane:h,valueMutated:i}=this,{configurable:j}=f;if("writable"in f&&!("value"in f)){const a=o(g,c);f.value=a.value}return l(g,c,d(f)),!1===j&&l(b,c,e(h,f)),a(i)||i(g,c),!0}}class A{constructor(b,c,d){this.originalTarget=c,this.membrane=b,a(d)||(this.valueObserved=d.valueObserved)}get(b,c){const{membrane:d,originalTarget:e}=this;if(c===w)return e;const f=e[c],{valueObserved:g}=this;return a(g)||g(e,c),d.getReadOnlyProxy(f)}set(){return!1}deleteProperty(){return!1}apply(){}construct(){}has(b,c){const{originalTarget:d}=this,{valueObserved:e}=this;return a(e)||e(d,c),c in d}ownKeys(){const{originalTarget:a}=this;return t.call(p(a),q(a))}setPrototypeOf(){}getOwnPropertyDescriptor(b,c){const{originalTarget:d,membrane:e,valueObserved:f}=this;a(f)||f(d,c);let h=o(d,c);if(a(h))return h;const i=o(b,c);return h.configurable||i||(h=g(e,h),l(b,c,h)),i||h}preventExtensions(){return!1}defineProperty(){return!1}}return class{constructor(b){this.objectGraph=new WeakMap,a(b)||(this.valueDistortion=b.valueDistortion,this.valueMutated=b.valueMutated,this.valueObserved=b.valueObserved)}getProxy(c){const{valueDistortion:d}=this,e=a(d)?c:d(c);if(b(e)){const a=this.getReactiveState(e);return a.readOnly===c?c:a.reactive}return e}getReadOnlyProxy(c){const{valueDistortion:d}=this,e=a(d)?c:d(c);return b(e)?this.getReactiveState(e).readOnly:e}unwrapProxy(a){return y(a)}getReactiveState(a){const b=this,{objectGraph:c,valueMutated:d,valueObserved:e}=b;a=y(a);let f=c.get(a);return f?f:(f=m(k(null),{reactive:{get(){const c=new z(b,a,{valueMutated:d,valueObserved:e}),f=new Proxy(h(a),c);return l(this,"reactive",{value:f}),f},configurable:!0},readOnly:{get(){const c=new A(b,a,{valueObserved:e}),d=new Proxy(h(a),c);return l(this,"readOnly",{value:d}),d},configurable:!0}}),c.set(a,f),f)}}});
